# lab2 HTTP 报文捕获



>1.实验环境

本实验使用`XAMPP`软件集成的`Apache`套件来在本机上建立服务器,供虚拟机的浏览器访问其`HTML`文件.

`Apache`套件默认使用`80`和`443`端口,需要访问的本机`HTML`文件需要放在路径`~/XAMPP/htdocs`下.



> 2.网页启动过程

编写含有任意信息的`HTML`文件存放在`~/XAMPP/htdocs`路径下,如下(文件名`info.html`)

```html
<!doctype html>

<html>

<head>

<title>Document</title>

</head>

<body>

<p>nothing but picture</p>

<img src="1.jpg">

<img src="3.jpg">

<p>from 1811464 郑佶</p>


</body>

</html>
```

在本机上使用`ipconfig`指令输出本机`ip`相关信息,从中找到本机`IPV4地址`.

使用`VMware`建立的`windows10`虚拟机的网页浏览器(如`IE`)的`URL栏`输入`本机IPV4地址/info.html`或是`127.0.0.1/info.html`,以打开该网页.

特别的,使用若在`HTML`文档中使用中文,需要在编辑时使用`GBK`编码,而不是默认的`UTF-8`编码.



> 3.HTML报文捕获过程

1. 首先启动`wireshark`软件,选择`Adapter for loopback traffic capture`(环回流量捕获适配器).
2. 启动`XMAPP`的`Apache`套件.
3. 在`wireshark`界面的条件筛选框中输入`ip.addr == 本机IPV4地址`或是`ip.addr == 127.0.0.1 `.
4. 打开`windows10`虚拟机,使用`IE`浏览器打开网页.
5. 观察到符合条件的捕获的报文增加(`TCP`协议类型和`HTTP`协议类型).



> 4.HTML报文捕获分析

> > 1.三次握手

一次完整的网页访问的报文捕获,从三次握手开始.三次握手为三次`TCP`协议的连接.

在`wireshark`中可以看到,`Info`信息栏中分别带有`[SYN]`, `[SYN],[ACK]`, `[ACK]`标签的三次连接就是所谓的"三次握手".

带有`[SYN]`标签的第一次握手,客户端发送`SYN`报文.标志位`SYN`值为1,确认序号`ACK`为0,序列号`SEQ`值为0.客户端进入`SYN_SENT`状态.

带有 `[SYN],[ACK]`标签的第二次握手,服务端确认收到客户端`SYN`报文,并发回`SYN+ACK`报文.其中,标志位`SYN`值不变仍为1,确认序号`ACK`被设为客户端`SYN`报文中序列号`SEQ`的值+1,序列号`SEQ`值不变.服务端进入`SYN_RECV`状态.

带有 `[ACK]`标签的第三次握手,客户端确认收到服务端的`SYN+ACK`报文,并再次发送确认包.其中,标志位`SYN`值被置零,确认序号`ACK`被设为1,序列号`SEQ`值置为1.

至此,客户端和服务器进入`ESTABLISHED`状态，连接建立完成三次握手结束.

> > 2.数据传输

三次握手结束后,就可以开始数据传输.

传输的过程,主要包括使用`HTTP`协议的文件资源请求`GET`报文和使用`TCP`协议的`ACK`确认报文,以及表示请求状态的`200`和`304`状态码.

客户端发出`GET`报文,服务端用`ACK`报文作为回应.

若资源无需更新,则是由服务器发出`304`状态码的`HTTP`协议报文,客户端以`ACK`报文回应.

如请求完成,则是由服务器发出`200`状态码的`HTTP`协议报文,客户端以`ACK`报文回应.

特别的,每次数据传输时的`ACK`报文中,序列号`SEQ`需要用对方上一次发来的`ACK`报文中的确认序号`ACK`赋值,并且刷新确认序号`ACK`的值,这是为了检验传输的完整性.

> > 3.断开连接

数据传输完成后,需要关闭连接.

关闭连接的过程,包括关闭双向的`TCP`连接.则分别需要服务端和客户端先后向对方发送带有`[FIN],[ACK]`标签的报文,并分别以`ACK`报文回应.

特别的,发送的`ACK`报文中,序列号`SEQ`需要用对方上一次发来的`FIN+ACK`报文中的确认序号`ACK`赋值,并且序列号`ACK`需要用对方上一次发来的`FIN+ACK`报文中的确认序号`SEQ`的值+1来赋值.而且,第二次发送的`FIN+ACK`报文(即客户端向服务端发送的断开连接请求),使用第一次发送的`ACK`报文(即客户端对从服务端发送的断开连接请求的确认报文)的序列号`SEQ`和确认序号`ACK`.这是同样是为了实现检验传输的完整性.